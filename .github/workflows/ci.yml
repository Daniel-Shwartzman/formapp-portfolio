name: CI

on:
  push:
    branches: 
      - main
      - devops

env:
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_ACCESS_TOKEN: ${{ secrets.DOCKER_ACCESS_TOKEN }}
  IMAGE_NAME: flask-web
  TAG: latest

jobs:
  CI:
    runs-on: ubuntu-latest
    outputs:
      new_tag: ${{ steps.tag.outputs.new_tag }}
    strategy:
      matrix:
        python-version: ["3.10"]

    steps:
    - name: Notify Slack - Starting CI
      uses: act10ns/slack@v2.0.0
      with:
        status: starting
        message: Starting CI....
      if: always()    

    - uses: actions/checkout@v3
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt pylint pytest

    - name: Build and Test the Docker compose
      id: build
      run: |
        docker-compose build
        docker-compose up -d
        sleep 5
        docker-compose down
        pytest tests/

    - name: Analysing the code with pylint
      id: pylint
      run: |
        pylint $(git ls-files '*.py')
    
    - name: Slack Notification
      uses: act10ns/slack@v2.0.0
      # send message even if the ci fails
      if: always()
      with:
        status: ${{ job.status }}
        steps: ${{ toJson(steps) }}

    - name: Github Tag Bump
      id: tag 
      if: ${{ github.ref == 'refs/heads/main' }}
      uses: anothrNick/github-tag-action@1.67.0
      env:
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        WITH_V: false
        DEFAULT_BUMP: patch
        INITIAL_VERSION: 1.0
        DEFAULT_BRANCH: main
      with:
        dry_run: true

    - name: Publish Docker Image to DockerHub
      if: success()
      run: |
        TAG=$(git describe --tags)
        echo $DOCKER_ACCESS_TOKEN | docker login -u $DOCKER_USERNAME --password-stdin
        docker build -t $IMAGE_NAME:$TAG .
        docker tag $IMAGE_NAME:$TAG sbendarsky/$IMAGE_NAME:$TAG
        docker push sbendarsky/$IMAGE_NAME:$TAG

    - name: Slack Notification
      uses: act10ns/slack@v2.0.0
      # send message even if the ci fails
      if: always()
      with:
        status: ${{ job.status }}
        steps: ${{ toJson(steps) }}

    




 

    

    

    